---
title: 数据算法----二次排序
date: 2018-06-04 15:58:43
tags: [分布式算法, 大数据, 机器学习]
---
#### 一. 二次排序(secondary sort)问题的引出 ####

**1. 二次排序**: 

在规约阶段对与某个键关联的值排序,又称为键值转换;

**2. MR中的排序:**

MapReduce框架会自动对mapper生成的键排序,说明在启动reducer之前,mapper生成的所有中间键值对必然是**按键有序**的.但是传入reducer的值并不是有序的,他们可能有任意的顺序,要想对reducer中的值进行排序,可以用二次排序设计模式实现.

**3. 通过MR的范式分析二次排序**:

map(key1,value1)--->list(key2,value2)
reduce(list(key2,value2))--->list(key3,value3)
list(key2,value2)作为reducer的输入,list(value2)=(V1,V2,V3...,Vn),其本身是无序的.
二次排序的目标就是让reducer收到的值有某种顺序.

**4. 问题引入**

假如我们有一组温度数据,按照'年\月\日\温度'的格式存储, 我们希望输入每一个年月的温度,并且按照升序排序:

```
2012-01: 5, 10, 25, 30...
2012-02: 18, 25, 30...
2012-08: 13, 20, 35...
```

#### 二. 二次排序问题的解决方案

* 1.让reducer读取和缓存给定键的所有值,然后对这些值完成in-reducer排序,数据量大时可能导致内存溢出
* 2.使用MapReduce框架对reducer值排序(这样就不需要再对传入reducer的值进行reducer中的排序),这种方法"会为自然键增加部分或整个值来创建一个组合键以实现排序目标",不会造成内存溢出
  * 使用键值转换设计模式:构造一组中间键(K, V1),其中V1是次键,K称为自然键,要在reducer键中注入一个值,只需要创建一个组合键.在本例中,V1就是温度数据
  * 让MapReduce执行框架完成排序(利用集群的力量)
  * 保留多个键值对状态来完成处理,可以适当利用mapper的partitioner来实现.

**1.中间键的排序顺序**

![](http://p5s7d12ls.bkt.clouddn.com/18-6-4/84337503.jpg)

要实现二次排序,我们需要控制中间键的排序顺序,以及reducer处理键的顺序,首先要在组合键中注入一个值(temperature),然后控制中间键的排序顺序.

因为希望reducer按照温度排序,所以增加temperature.要用compareTo方法指出如何对DateTemperaturePair对象排序.

>  在Hadoop中,要持久存储定制数据类型,则必须实现Writable接口,要比较定制数据类型,必须实现WritableComparable接口

```java

```

