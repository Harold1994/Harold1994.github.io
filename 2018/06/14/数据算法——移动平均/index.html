<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>数据算法——移动平均 | lyyourc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css">
  <!-- <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'> -->
  
</head>

<body>
  <nav class="app-nav">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives">archive</a>
    
  
    
      <a href="/atom.xml">rss</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2018/06/14/数据算法——移动平均/">数据算法——移动平均</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">June 14 2018</p>
  </section>

  <section class="article-entry">
    <h4 id="一、移动平均的基本概念"><a href="#一、移动平均的基本概念" class="headerlink" title="一、移动平均的基本概念"></a>一、移动平均的基本概念</h4><p>​    时间序列数据表示一个变量在一段时间内的值，可以将时间序列数据形式化表示为三元组序列：(k,t,v)</p>
<p>这里k是键(如股票代码)，t是时间（小时、分钟或秒），v是关联的值（如一只股票在t的值）。</p>
<p>​    一般的，只要在一段时间内记录相同的度量值，就会得到时间序列数据。多个连续周期的时间序列数据平均值（按相同时间间隔得到的观察值）称为移动平均。之所以称为“移动”，是因为随着新时间序列数据的到来，要不断重新计算这个平均值，由于会删除最早的值的同时增加最新的值，这个平均值会相应的“移动”。<br><a id="more"></a><br><strong>形式定义：</strong></p>
<p>令A为一组有序对象的序列：<br>$A = (a_1,a_2,a_3,…,a_N)$</p>
<p>可以把A表示为：$\lbrace a_i\rbrace_{i=1}^N $</p>
<p>n移动平均序列是由$a_i$定义的一个新序列</p>
<p>$\lbrace S_i\rbrace_{i=1}^{N-n+1} $</p>
<p>这是通过计算n项子序列的算术平均值来得到的：<br>$s_i = \frac 1n\sum_{j=i}^{i+n-1}a_j$</p>
<p>所以n移动平均序列$S_n$计算如下：</p>
<p>$S_2 = \frac12[(a_1+a_2),(a_2+a_3),…,(a_{n-1}+a_n)]$</p>
<p>$S_3 = \frac13[(a_1+a_2+a_3),(a_2+a_3+a_4),…,(a_{n-2}+a_{n-1}+a_n)]$</p>
<p>$S_4 = \frac14[(a_1+a_2+a_3+a_4),(a_2+a_3+a_4+a_5)…$</p>
<h4 id="二、POJO移动平均解决方案"><a href="#二、POJO移动平均解决方案" class="headerlink" title="二、POJO移动平均解决方案"></a>二、POJO移动平均解决方案</h4><p>我们可以将窗口实现为一个队列数据结构，以一种先进先出的方式填入时间序列数据点，直至其中包含N个数据点（这N个点的均值就是移动平均数）。这里提供两个方案：</p>
<ul>
<li>使用java.util.queue</li>
<li>使用数组模拟队列</li>
</ul>
<p><strong>1.使用队列</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lihe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Title</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 使用队列求移动均值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/6/14上午11:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleMovingAverage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> sum = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> period;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Double&gt; window = <span class="keyword">new</span> LinkedList&lt;Double&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleMovingAverage</span><span class="params">(<span class="keyword">int</span> period)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (period &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"period must be &gt;0"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.period = period;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNewNumber</span><span class="params">(Double number)</span> </span>&#123;</span><br><span class="line">        sum += number;</span><br><span class="line">        window.add(number);</span><br><span class="line">        <span class="keyword">if</span> (window.size() &gt; period)</span><br><span class="line">            sum -= window.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getMovingAverage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (window.isEmpty())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"average is undefined"</span>);</span><br><span class="line">        <span class="keyword">return</span> sum/window.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2.使用数组</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lihe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Title</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 使用数组算MovingAverage</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/6/14上午11:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleMovingAverageUsingArray</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> period;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span>[] window = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> pointer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleMovingAverageUsingArray</span><span class="params">(<span class="keyword">int</span> period)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (period &lt; <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"period must be &gt; 0"</span>);</span><br><span class="line">        <span class="keyword">this</span>.period = period;</span><br><span class="line">        window = <span class="keyword">new</span> <span class="keyword">double</span>[period];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNewNumber</span><span class="params">(<span class="keyword">double</span> number)</span> </span>&#123;</span><br><span class="line">        sum += number;</span><br><span class="line">        <span class="keyword">if</span> (size &lt; period) &#123;</span><br><span class="line">            window[pointer++] = number;</span><br><span class="line">            size++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pointer = pointer % period;</span><br><span class="line">            sum -= window[pointer];</span><br><span class="line">            window[pointer++] = number;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getMovingAverage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"average is undefined"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum / size;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3.测试POJO移动平均</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lihe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Title</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 测试移动平均</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/6/14下午1:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSimpleMovingAverage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger THE_LOGGER = Logger.getLogger(TestSimpleMovingAverage.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span>[] testData = &#123;<span class="number">10</span>, <span class="number">18</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">33</span>, <span class="number">27</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span>[] allWindowSizes = &#123;<span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> windowSize : allWindowSizes) &#123;</span><br><span class="line">            SimpleMovingAverage sma = <span class="keyword">new</span> SimpleMovingAverage(windowSize);</span><br><span class="line">            THE_LOGGER.info(<span class="string">"windowSize:"</span> + windowSize);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">double</span> x : testData) &#123;</span><br><span class="line">                sma.addNewNumber(x);</span><br><span class="line">                THE_LOGGER.info(<span class="string">"Next Number = "</span> + x + <span class="string">", SMA = "</span> + sma.getMovingAverage());</span><br><span class="line">            &#125;</span><br><span class="line">            THE_LOGGER.info(<span class="string">"---"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="三、Mapreduce-Hadoop移动平均解决方案"><a href="#三、Mapreduce-Hadoop移动平均解决方案" class="headerlink" title="三、Mapreduce/Hadoop移动平均解决方案"></a>三、Mapreduce/Hadoop移动平均解决方案</h4><p>移动平均框架的计算由reduce()函数处理，这里可以得到一个特定时间序列的所有所需数据。</p>
<p><strong>输入：</strong></p>
<p><name-as-string>&lt;,&gt;<date-as-string>&lt;,&gt;<value-as-double></value-as-double></date-as-string></name-as-string></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GOOG,2004-11-04,184.70</span><br><span class="line">GOOG,2004-11-03,191.67</span><br><span class="line">GOOG,2004-11-02,194.87</span><br><span class="line">AAPL,2013-10-09,486.59</span><br><span class="line">AAPL,2013-10-08,480.94</span><br><span class="line">AAPL,2013-10-07,487.75</span><br><span class="line">AAPL,2013-10-04,483.03</span><br><span class="line">AAPL,2013-10-03,483.41</span><br><span class="line">IBM,2013-09-30,185.18</span><br><span class="line">IBM,2013-09-27,186.92</span><br><span class="line">IBM,2013-09-26,190.22</span><br><span class="line">IBM,2013-09-25,189.47</span><br><span class="line">GOOG,2013-07-19,896.60</span><br><span class="line">GOOG,2013-07-18,910.68</span><br><span class="line">GOOG,2013-07-17,918.55</span><br></pre></td></tr></table></figure>
<p>以上数据代表三个公司的股价，第一列是公司，第二列是时间，第三列是当天的以调整收盘价。</p>
<p><strong>输出：</strong></p>
<p><name-as-string>&lt;,&gt;<date-as-string>&lt;,&gt;<movig-average-as-double></movig-average-as-double></date-as-string></name-as-string></p>
<p>计算移动平均数，只需要根据股票代码对数据分组，然后按时间对这些值排序，最后运用移动平均算法。对时间序列排序的方法可以有以下两种方法：</p>
<ul>
<li>1.在内存中排序</li>
<li>2.利用Mapreduce框架在时间序列数据的排序</li>
</ul>
<p>由于之前的博客中已经详细介绍过二次排序的问题，本博客仅展示在内存中排序的部分代码：</p>
<p>Mapper接受一个格式为<name-as-string>&lt;,&gt;<date-as-string>&lt;,&gt;<value-as-double>的输入行，然后发出键值对，其中键是：<name-as-string>，值是：<date-as-string>&lt;,&gt;<value-as-double>，reducer会接受键值对，然后完成内存中排序。</value-as-double></date-as-string></name-as-string></value-as-double></date-as-string></name-as-string></p>
<p><strong>时间序列数据：</strong>时间序列数据表示为一个TimeSeriesData对象，因为对象会在Hadoop中持久存储，并完成内存中的排序，因此这个类实现了WritableComparable<timeseriesdata>.</timeseriesdata></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lihe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Title</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 时间序列存储格式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/6/14下午3:13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeSeriesData</span> <span class="keyword">implements</span> <span class="title">WritableComparable</span>&lt;<span class="title">TimeSeriesData</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> timestamp;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TimeSeriesData</span><span class="params">(<span class="keyword">long</span> timestamp, <span class="keyword">double</span> value)</span> </span>&#123;</span><br><span class="line">        set(timestamp, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TimeSeriesData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">long</span> timestamp, <span class="keyword">double</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.timestamp = timestamp;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTimestamp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TimeSeriesData <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TimeSeriesData(timestamp, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DateUtil.getDateAsString(timestamp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(TimeSeriesData o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.timestamp &lt; o.timestamp)</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.timestamp &gt; o.timestamp)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput dataOutput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        dataOutput.writeLong(timestamp);</span><br><span class="line">        dataOutput.writeDouble(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput dataInput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.timestamp = dataInput.readLong();</span><br><span class="line">        <span class="keyword">this</span>.value = dataInput.readDouble();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"("</span> + timestamp + <span class="string">","</span> + value + <span class="string">")"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Mapper:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lihe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Title</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/6/14下午3:28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SortInMemory_MovingAverageMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">TimeSeriesData</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Text reduceKey = <span class="keyword">new</span> Text();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TimeSeriesData reducerValue = <span class="keyword">new</span> TimeSeriesData();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        String record = value.toString();</span><br><span class="line">        <span class="keyword">if</span> ((record == <span class="keyword">null</span>) || (record.length() == <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] tokens = StringUtils.split(record, <span class="string">','</span>);</span><br><span class="line">        <span class="keyword">if</span> (tokens.length == <span class="number">3</span>) &#123;</span><br><span class="line">            Date date = DateUtil.getDate(tokens[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">if</span> (date == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            reduceKey.set(tokens[<span class="number">0</span>]);</span><br><span class="line">            reducerValue.set(date.getTime(), Double.parseDouble(tokens[<span class="number">2</span>]));</span><br><span class="line">            context.write(reduceKey, reducerValue);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//log as error, not enough tokens</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>reducer:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SortInMemory_MovingAverageReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">TimeSeriesData</span>, <span class="title">Text</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> windowSize = <span class="number">5</span>;<span class="comment">//默认窗口大小</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.windowSize = context.getConfiguration().getInt(<span class="string">"moving.average.window.size"</span>, <span class="number">5</span>);</span><br><span class="line">        System.out.println(<span class="string">"setup(): key="</span> + windowSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;TimeSeriesData&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        List&lt;TimeSeriesData&gt; timeSeries = <span class="keyword">new</span> ArrayList&lt;TimeSeriesData&gt;();</span><br><span class="line">        <span class="keyword">for</span> (TimeSeriesData tsData : values) &#123;</span><br><span class="line">            TimeSeriesData copy = tsData.clone();</span><br><span class="line">            timeSeries.add(copy);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Collections.sort(timeSeries);</span><br><span class="line">        System.out.println(<span class="string">"reduce(): timeseries="</span> + timeSeries.toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//计算前缀和</span></span><br><span class="line">        <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; windowSize; i++) &#123;</span><br><span class="line">            sum += timeSeries.get(i).getValue();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Text outputValue = <span class="keyword">new</span> Text();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = windowSize; i &lt; timeSeries.size(); i++) &#123;</span><br><span class="line">            sum += timeSeries.get(i).getValue();</span><br><span class="line">            <span class="keyword">double</span> movingAverage = sum / windowSize;</span><br><span class="line">            <span class="keyword">long</span> timestamp = timeSeries.get(i).getTimestamp();</span><br><span class="line">            outputValue.set(DateUtil.getDateAsString(timestamp) + <span class="string">","</span> + movingAverage);</span><br><span class="line">            context.write(key, outputValue);</span><br><span class="line">            sum -= timeSeries.get(i - windowSize + <span class="number">1</span>).getValue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Driver:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SortInMemory_MovingAverageDriver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">       String[] otherArgs = <span class="keyword">new</span> GenericOptionsParser(conf, args).getRemainingArgs();</span><br><span class="line">       <span class="keyword">if</span> (otherArgs.length != <span class="number">3</span>) &#123;</span><br><span class="line">          System.err.println(<span class="string">"Usage: SortInMemory_MovingAverageDriver &lt;window_size&gt; &lt;input&gt; &lt;output&gt;"</span>);</span><br><span class="line">          System.exit(<span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       System.out.println(<span class="string">"args[0]: &lt;window_size&gt;="</span>+otherArgs[<span class="number">0</span>]);</span><br><span class="line">       System.out.println(<span class="string">"args[1]: &lt;input&gt;="</span>+otherArgs[<span class="number">1</span>]);</span><br><span class="line">       System.out.println(<span class="string">"args[2]: &lt;output&gt;="</span>+otherArgs[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">       Job job = <span class="keyword">new</span> Job(conf, <span class="string">"SortInMemory_MovingAverageDriver"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// add jars to distributed cache</span></span><br><span class="line">       HadoopUtil.addJarsToDistributedCache(job, <span class="string">"/lib/"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// set mapper/reducer</span></span><br><span class="line">       job.setMapperClass(SortInMemory_MovingAverageMapper.class);</span><br><span class="line">       job.setReducerClass(SortInMemory_MovingAverageReducer.class);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// define mapper's output key-value</span></span><br><span class="line">       job.setMapOutputKeyClass(Text.class);</span><br><span class="line">       job.setMapOutputValueClass(TimeSeriesData.class);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// define reducer's output key-value</span></span><br><span class="line">       job.setOutputKeyClass(Text.class);</span><br><span class="line">       job.setOutputValueClass(Text.class);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// set window size for moving average calculation</span></span><br><span class="line">       <span class="keyword">int</span> windowSize = Integer.parseInt(otherArgs[<span class="number">0</span>]);</span><br><span class="line">       job.getConfiguration().setInt(<span class="string">"moving.average.window.size"</span>, windowSize);      </span><br><span class="line"></span><br><span class="line">       <span class="comment">// define I/O</span></span><br><span class="line">       FileInputFormat.addInputPath(job, <span class="keyword">new</span> Path(otherArgs[<span class="number">1</span>]));</span><br><span class="line">       FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(otherArgs[<span class="number">2</span>]));</span><br><span class="line"></span><br><span class="line">       job.setInputFormatClass(TextInputFormat.class);</span><br><span class="line">       job.setOutputFormatClass(TextOutputFormat.class);</span><br><span class="line"></span><br><span class="line">       System.exit(job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="http://7xrcp8.com1.z0.glb.clouddn.com/avatar.png" alt="avatar" />
    <div class="grid-item">
      <p class="title"> lyyourc </p>
      <p class="subtitle"> You Are The JavaScript In My HTML </p>
    <div>
  </section>

  <section class="share-btns">
    <!-- <p> share it if you like it~ </p> -->
    <a
  class="twitter-share-button"
  data-size="large"
  data-via="DrakeLeung"
  href="https://twitter.com/intent/tweet?text= id="一、移动平均的基本概念"><a"
>
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'drakeleung';
  
  var disqus_url = '//harold.me/2018/06/14/数据算法——移动平均/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
</main>

</body>
</html>
