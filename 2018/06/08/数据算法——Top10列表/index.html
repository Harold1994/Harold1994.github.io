<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>数据算法——Top 10列表 | lyyourc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css">
  <!-- <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'> -->
  
</head>

<body>
  <nav class="app-nav">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives">archive</a>
    
  
    
      <a href="/atom.xml">rss</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2018/06/08/数据算法——Top10列表/">数据算法——Top 10列表</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">June 08 2018</p>
  </section>

  <section class="article-entry">
    <p>top10列表问题是一种过滤模式的问题，即需要过滤数据，找出top N列表,本篇博客将分别利用MR和Spark实现top N设计模式。</p>
<h4 id="一、Top-N设计模式的形式化描述"><a href="#一、Top-N设计模式的形式化描述" class="headerlink" title="一、Top N设计模式的形式化描述"></a>一、Top N设计模式的形式化描述</h4><p>令N是一个整数，而且N&gt;0。令L是一个$List&lt;Tuple2&lt;T,Integer&gt;&gt;$,其中T可以是任意类型；$L.size() = S,S &gt; N$,L的元素为：</p>
<p>​                                $\lbrace (K_i,V_i),1\leq i\leq S\rbrace$</p>
<p>其中$K_i$类型为T，$V_i$为Integer类型（为$K_i$的频度）。令sort(L)返回已排序的L值，这里使用频度作为键，如下所示：</p>
<p>​                                $\lbrace (A_j,B_j),1\leq j\leq S,B_1\geq B_2\geq …\geq B_S \rbrace$</p>
<p>其中$(A_j,B_j) \in L $,则Top N的定义为：</p>
<p>​                $topN(L) =\lbrace (A_j,B_j),1\leq j\leq N,B_1\geq B_2\geq …\geq B_N \geq …\geq B_s \rbrace$<br><a id="more"></a><br>为实现Top N，需要一个散列表数据结构，从而可以得到键的全序，在Java中可以使用SortedMap&lt;K,V&gt;(作为接口)和TreeMap&lt;K,V&gt;(作为SortedMap的一个实现类).</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SortedMap&lt;Integer, T&gt; <span class="title">topN</span><span class="params">(List&lt;Tuple2&lt;T, Integer&gt;&gt; L, <span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((L == <span class="keyword">null</span>) || (L.isEmpty())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    SortedMap&lt;Integer, T&gt; topN = <span class="keyword">new</span> TreeMap&lt;Integer, T&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Tuple2&lt;T, Integer&gt; element : L) &#123;</span><br><span class="line">        topN.put(element._2, element._1);</span><br><span class="line">        <span class="keyword">if</span> (topN.size() &gt; N) &#123;</span><br><span class="line">            topN.remove(topN.firstKey());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> topN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="二、MapReduce-Hadoop实现：唯一键"><a href="#二、MapReduce-Hadoop实现：唯一键" class="headerlink" title="二、MapReduce/Hadoop实现：唯一键"></a>二、MapReduce/Hadoop实现：唯一键</h4><p>首先将输入分区为小块，每个小块发送到一个mapper，每个mapper产生一个top N列表，然后将列表发送到reduce如，发出mapper输出时，使用同一个reducer键，这样所有mapper输出都将由一个reducer处理。</p>
<p><img src="http://p5s7d12ls.bkt.clouddn.com/18-6-11/20636935.jpg" alt=""></p>
<p><strong>Mapper:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**                                                                                                                   </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lihe                                                                                                       </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Title</span>: TopNMapper                                                                                                 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 唯一键Mapper                                                                                            </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/6/11下午2:19                                                                                              </span></span><br><span class="line"><span class="comment"> */</span>                                                                                                                   </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopNMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">NullWritable</span>, <span class="title">Text</span>&gt; </span>&#123;                                       </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> N = <span class="number">10</span>;                                                                                               </span><br><span class="line">    <span class="keyword">private</span> SortedMap&lt;Integer, String&gt; top = <span class="keyword">new</span> TreeMap&lt;Integer, String&gt;();                                          </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>                                                                                                         </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Text key, IntWritable value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;       </span><br><span class="line">        String keyAsString = key.toString();                                                                          </span><br><span class="line">        <span class="keyword">int</span> frequency = value.get();                                                                                  </span><br><span class="line">        String compositValue = keyAsString + <span class="string">","</span> + frequency;                                                         </span><br><span class="line">        top.put(frequency, compositValue);                                                                            </span><br><span class="line">        <span class="keyword">if</span> (top.size() &gt; N) &#123;                                                                                         </span><br><span class="line">            top.remove(top.firstKey());                                                                               </span><br><span class="line">        &#125;                                                                                                             </span><br><span class="line">    &#125;                                                                                                                 </span><br><span class="line">    <span class="comment">//每个mapper执行一次,一开始从参数中获取N                                                                                         </span></span><br><span class="line">    <span class="meta">@Override</span>                                                                                                         </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;                                  </span><br><span class="line">        <span class="keyword">this</span>.N = context.getConfiguration().getInt(<span class="string">"N"</span>, <span class="number">10</span>);                                                          </span><br><span class="line">    &#125;                                                                                                                 </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>                                                                                                         </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;                                </span><br><span class="line">        <span class="keyword">for</span> (String str : top.values())                                                                               </span><br><span class="line">            context.write(NullWritable.get(), <span class="keyword">new</span> Text(str));                                                         </span><br><span class="line">    &#125;                                                                                                                 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Reducer:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lihe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Title</span>: TopNReducer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 唯一键做reduc，所有数据都到单个reducer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/6/11下午2:33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopNReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">NullWritable</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> N = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> SortedMap&lt;Integer,String&gt; top = <span class="keyword">new</span> TreeMap&lt;Integer, String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(NullWritable key, Iterable&lt;Text&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Text value : values) &#123;</span><br><span class="line">            String valueAsString = value.toString().trim();</span><br><span class="line">            String [] tokens = valueAsString.split(<span class="string">","</span>)；</span><br><span class="line">            String url = tokens[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">int</span> frequency = Integer.parseInt(tokens[<span class="number">1</span>]);</span><br><span class="line">            top.put(frequency, url);</span><br><span class="line">            <span class="keyword">if</span> (top.size() &gt; N) &#123;</span><br><span class="line">                top.remove(top.firstKey());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Integer&gt; keys = <span class="keyword">new</span> ArrayList&lt;&gt;(top.keySet());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=keys.size()-<span class="number">1</span>; i&gt;= <span class="number">0</span>; i--)</span><br><span class="line">            context.write(<span class="keyword">new</span> IntWritable(keys.get(i)), <span class="keyword">new</span> Text(top.get(keys.get(i))));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.N = context.getConfiguration().getInt(<span class="string">"N"</span>, <span class="number">10</span>); <span class="comment">// default is top 10</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="三、Spark实现：唯一键"><a href="#三、Spark实现：唯一键" class="headerlink" title="三、Spark实现：唯一键"></a>三、Spark实现：唯一键</h4><p>在这个实现中，我们假定对于所有&lt;K,V&gt;对，K是唯一的，在本节不会使用Spark的排序函数，如top()或takeOrdered().</p>
<p><strong>步骤：</strong></p>
<ul>
<li>导入必要的类</li>
<li>处理输入参数：确保有一个输入参数：HDFS输入文件</li>
<li>连接Spark master</li>
<li>从HDFS读取输入文件并创建RDD</li>
<li>Top10类：从现有RDD<string>创建出PairRDD&lt;Integer,String&gt;</string></li>
<li>为各个输入分区创建本地top 10列表，mapPartitions</li>
<li>使用collect()或者reduce()创建最终top10列表</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TopN</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">if</span> (args.size &lt; <span class="number">1</span>) &#123;</span><br><span class="line">      println(<span class="string">"Usage : TopN &lt;input&gt;"</span>)</span><br><span class="line">      sys.exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> sparkConf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"TopN"</span>)</span><br><span class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(sparkConf)</span><br><span class="line">    <span class="comment">//将N设为全局变量</span></span><br><span class="line">    <span class="keyword">val</span> <span class="type">N</span> = sc.broadcast(<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">val</span> path = args(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> input = sc.textFile(path)</span><br><span class="line">    <span class="keyword">val</span> pair = input.map(line =&gt; &#123;</span><br><span class="line">      <span class="keyword">var</span> tokens = line.split(<span class="string">","</span>)</span><br><span class="line">      (tokens(<span class="number">2</span>).toInt, tokens)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> <span class="type">Ordering</span>.<span class="type">Implicits</span>._</span><br><span class="line">    <span class="keyword">val</span> partitions = pair.mapPartitions(itr =&gt; &#123;</span><br><span class="line">      <span class="keyword">var</span> sortedMap = <span class="type">SortedMap</span>.empty[<span class="type">Int</span>, <span class="type">Array</span>[<span class="type">String</span>]]</span><br><span class="line">      itr.foreach &#123; tuple =&gt; &#123;</span><br><span class="line">        sortedMap += tuple</span><br><span class="line">        <span class="keyword">if</span> (sortedMap.size &gt; <span class="type">N</span>.value) &#123;</span><br><span class="line">          sortedMap = sortedMap.takeRight(<span class="type">N</span>.value)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      sortedMap.takeRight(<span class="type">N</span>.value).toIterator</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> alltop10 = partitions.collect()</span><br><span class="line">    <span class="keyword">val</span> finaltop10 = <span class="type">SortedMap</span>.empty[<span class="type">Int</span>, <span class="type">Array</span>[<span class="type">String</span>]].++(alltop10)</span><br><span class="line">    <span class="keyword">val</span> resultUsingMapPartiton = finaltop10.takeRight(<span class="type">N</span>.value)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打印输出</span></span><br><span class="line">    resultUsingMapPartiton.foreach(&#123;</span><br><span class="line">      <span class="keyword">case</span> (k, v) =&gt; println(<span class="string">s"<span class="subst">$k</span> \t <span class="subst">$&#123;v.asInstanceOf[Array[String]].mkString(",")&#125;</span>"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> moreConciseApproach = pair.groupByKey().sortByKey(<span class="literal">false</span>).take(<span class="type">N</span>.value)</span><br><span class="line">    moreConciseApproach.foreach &#123;</span><br><span class="line">      <span class="keyword">case</span> (k, v) =&gt; println(<span class="string">s"<span class="subst">$k</span> \t <span class="subst">$&#123;v.flatten.mkString(",")&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="四、Spark实现：非唯一键"><a href="#四、Spark实现：非唯一键" class="headerlink" title="四、Spark实现：非唯一键"></a>四、Spark实现：非唯一键</h4><p>在实际的应用中可能会出现K不唯一的情况，比如统计一个网站最常被访问的是个URL，假设我们有三个Web服务器，只有7个URL，分别为A，B，C，D，E，F，对应的服务器生成的统计如下表：</p>
<table>
<thead>
<tr>
<th>Web服务器1</th>
<th>Web服务器3</th>
<th>Web服务器3</th>
</tr>
</thead>
<tbody>
<tr>
<td>（A，2）</td>
<td>（A，1）</td>
<td>（A，2）</td>
</tr>
<tr>
<td>（B，2）</td>
<td>（B，1）</td>
<td>（B，4）</td>
</tr>
<tr>
<td>（C，4）</td>
<td>（C，5）</td>
<td>（C，2）</td>
</tr>
<tr>
<td>（F，3)</td>
<td>（E，1）</td>
<td>（D，3）</td>
</tr>
<tr>
<td></td>
<td>（F，2)</td>
<td>（E，2）</td>
</tr>
<tr>
<td></td>
<td></td>
<td>（F，1)</td>
</tr>
</tbody>
</table>
<p>如果先得到每个服务器的本地top N，在规约得到的数据并不正确，原因是所有服务器上的URL并不惟一。要得到正确的结果，必须为所有输入创建一组唯一的URL，然后再分区计算。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopNNonUnique</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">if</span> (args.size &lt; <span class="number">1</span>) &#123;</span><br><span class="line">      println(<span class="string">"Usage: TopNNonUnique &lt;input&gt;"</span>)</span><br><span class="line">      sys.exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> sparkConf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"TopNNonUnique"</span>)</span><br><span class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(sparkConf)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> <span class="type">N</span> = sc.broadcast(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">val</span> path = args(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> input = sc.textFile(path)</span><br><span class="line">    <span class="keyword">val</span> kv = input.map(line =&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> tokens = line.split(<span class="string">","</span>)</span><br><span class="line">      (tokens(<span class="number">0</span>), tokens(<span class="number">1</span>).toInt)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> uniqueKeys = kv.reduceByKey(_ + _)</span><br><span class="line">    <span class="keyword">import</span> <span class="type">Ordering</span>.<span class="type">Implicits</span>._</span><br><span class="line">    <span class="keyword">val</span> partitions = uniqueKeys.mapPartitions(itr =&gt; &#123;</span><br><span class="line">      <span class="keyword">var</span> sortedMap = <span class="type">SortedMap</span>.empty[<span class="type">Int</span>, <span class="type">String</span>]</span><br><span class="line">      itr.foreach &#123; tuple =&gt; &#123;</span><br><span class="line">        sortedMap += tuple.swap</span><br><span class="line">        <span class="keyword">if</span> (sortedMap.size &gt; <span class="type">N</span>.value) &#123;</span><br><span class="line">          sortedMap = sortedMap.takeRight(<span class="type">N</span>.value)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      sortedMap.takeRight(<span class="type">N</span>.value).toIterator</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> alltop2 = partitions.collect()</span><br><span class="line">    <span class="keyword">val</span> finaltop2 = <span class="type">SortedMap</span>.empty[<span class="type">Int</span>, <span class="type">String</span>].++(alltop2)</span><br><span class="line">    <span class="keyword">val</span> resultUsingMapPartiton = finaltop2.takeRight(<span class="type">N</span>.value)</span><br><span class="line"></span><br><span class="line">    resultUsingMapPartiton.foreach &#123;</span><br><span class="line">      <span class="keyword">case</span> (k, v) =&gt; println(<span class="string">s"<span class="subst">$k</span> \t <span class="subst">$&#123;v.mkString(",")&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更简 洁的一种方式</span></span><br><span class="line">    <span class="keyword">val</span> createCombiner = (v: <span class="type">Int</span>) =&gt; v</span><br><span class="line">    <span class="keyword">val</span> mergeValue = (a: <span class="type">Int</span>, b: <span class="type">Int</span>) =&gt; (a + b)</span><br><span class="line">    <span class="keyword">val</span> moreConciseApproach = kv.combineByKey(createCombiner, mergeValue, mergeValue)</span><br><span class="line">      .map(_.swap)</span><br><span class="line">      .groupByKey()</span><br><span class="line">      .sortByKey(<span class="literal">false</span>)</span><br><span class="line">      .take(<span class="type">N</span>.value)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Prints result (top 10) on the console</span></span><br><span class="line">    moreConciseApproach.foreach &#123;</span><br><span class="line">      <span class="keyword">case</span> (k, v) =&gt; println(<span class="string">s"<span class="subst">$k</span> \t <span class="subst">$&#123;v.mkString(",")&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意上面代码中使用combineByKey方法得到了一种更简洁的表达方式。combineByKey是Spark中一个比较核心的高级函数，其他一些高阶键值对函数底层都是用它实现的，诸如 groupByKey,reduceByKey等等，里面的参数分别代表：</p>
<ul>
<li>createCombiner: V =&gt; C ，这个函数把当前的值作为参数，此时我们可以对其做些附加操作(类型转换)并把它返回 (这一步类似于初始化操作)</li>
<li>mergeValue: (C, V) =&gt; C，该函数把元素V合并到之前的元素C(createCombiner)上 (这个操作在每个分区内进行)</li>
<li>mergeCombiners: (C, C) =&gt; C，该函数把2个元素C合并 (这个操作在不同分区间进行)</li>
</ul>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="http://7xrcp8.com1.z0.glb.clouddn.com/avatar.png" alt="avatar" />
    <div class="grid-item">
      <p class="title"> lyyourc </p>
      <p class="subtitle"> You Are The JavaScript In My HTML </p>
    <div>
  </section>

  <section class="share-btns">
    <!-- <p> share it if you like it~ </p> -->
    <a
  class="twitter-share-button"
  data-size="large"
  data-via="DrakeLeung"
  href="https://twitter.com/intent/tweet?text=top10列表问题是一种过滤模式的问题，"
>
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'drakeleung';
  
  var disqus_url = '//harold.me/2018/06/08/数据算法——Top10列表/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
</main>

</body>
</html>
