<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>用hadoop构建豆瓣图书推荐系统 | lyyourc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css">
  <!-- <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'> -->
  
</head>

<body>
  <nav class="app-nav">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives">archive</a>
    
  
    
      <a href="/atom.xml">rss</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2018/03/28/用hadoop构建豆瓣图书推荐系统/">用hadoop构建豆瓣图书推荐系统</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">March 28 2018</p>
  </section>

  <section class="article-entry">
    <p>《Hadoop权威指南》已经通读一遍，对于分布式数据处理大致有一些概念，从网上找一个合适的项目练练手，此博客记录了我基于<a href="http://blog.fens.me/hadoop-mapreduce-recommend/" target="_blank" rel="noopener">张丹大神的电影推荐系统</a>手搓的豆瓣图书推荐系统，Hadoop版本为2.8.0，爬虫用python scrapy框架来写。</p>
<p><strong>一、推荐系统概述</strong></p>
<p>互联网已经普及到了今天，更加上机器学习和大数据的浪潮火爆，几乎我们接触的所有网站、App等都会用到推荐系统，比如淘宝的猜你喜欢，头条的新闻推送等等。<br><a id="more"></a><br>常见的推荐原理有：</p>
<blockquote>
<p><em>基于用户基本信息的推荐</em> : 例如可以根据用户的性别、职业、 年龄、 所在地等信息向他推荐感兴趣或者相关的内容<br><em>基于物品/内容基本信息推荐</em> ： 根据物品的类型、来源、主题等信息推荐<br><em>协同推荐</em> ： 协同过滤算法通过计算用户之间或者物品之间的相关性来进行推荐</p>
</blockquote>
<p>协同过滤算法的实现分为两个步骤：<br>1.计算物品之间的相关度<br>2.根据物品的相似度和用户的历史行为给用户生成推荐列表<br><strong>二、算法模型</strong><br>这里我们用分步式基于物品的协同过滤算法实现为豆瓣用户推荐图书的系统。测试数据仍然用张丹大神原系统中的small.csv<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1,101,5.0</span><br><span class="line">1,102,3.0</span><br><span class="line">1,103,2.5</span><br><span class="line">2,101,2.0</span><br><span class="line">2,102,2.5</span><br><span class="line">2,103,5.0</span><br><span class="line">2,104,2.0</span><br><span class="line">3,101,2.0</span><br><span class="line">3,104,4.0</span><br><span class="line">3,105,4.5</span><br><span class="line">3,107,5.0</span><br><span class="line">4,101,5.0</span><br><span class="line">4,103,3.0</span><br><span class="line">4,104,4.5</span><br><span class="line">4,106,4.0</span><br><span class="line">5,101,4.0</span><br><span class="line">5,102,3.0</span><br><span class="line">5,103,2.0</span><br><span class="line">5,104,4.0</span><br><span class="line">5,105,3.5</span><br><span class="line">5,106,4.0</span><br></pre></td></tr></table></figure></p>
<p>每行3个字段，依次代表用户ID，图书ID，用户对图书的评分(0-5分）。<br>本推荐系统执行的思路：</p>
<ol>
<li><p>建立物品的同现矩阵： 同现矩阵的值代表了某两本书同时出现在用户的评价列表中的次数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">      [101] [102] [103] [104] [105] [106] [107]</span><br><span class="line">[101]   5     3     4     4     2     2     1</span><br><span class="line">[102]   3     3     3     2     1     1     0</span><br><span class="line">[103]   4     3     4     3     1     2     0</span><br><span class="line">[104]   4     2     3     4     2     2     1</span><br><span class="line">[105]   2     1     1     2     2     1     1</span><br><span class="line">[106]   2     1     2     2     1     2     0</span><br><span class="line">[107]   1     0     0     1     1     0     1</span><br></pre></td></tr></table></figure>
</li>
<li><p>建立用户对物品的评分矩阵： 有多少个用户就有多少个评分矩阵<br>​<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">       U3</span><br><span class="line">[101] 2.0</span><br><span class="line">[102] 0.0</span><br><span class="line">[103] 0.0</span><br><span class="line">[104] 4.0</span><br><span class="line">[105] 4.5</span><br><span class="line">[106] 0.0</span><br><span class="line">[107] 5.0</span><br></pre></td></tr></table></figure></p>
</li>
<li><p>矩阵计算推荐结果： 同现矩阵*评分矩阵 = 推荐结果<br><img src="http://p5s7d12ls.bkt.clouddn.com/18-3-28/78005679.jpg" alt=""></p>
</li>
</ol>
<p><strong>三、系统架构</strong><br><img src="http://p5s7d12ls.bkt.clouddn.com/18-3-28/71568403.jpg" alt=""></p>
<p>上图左边是Application业务系统，右边是本博客要实现的HDFS，MapReduce<br>1.业务系统记录了用户行为和用户对物品的打分（这里我们用爬取到的数据代替）<br>2.设置系统定时器CRON，隔一段时间增量向HDFS导入数据，即本系统需要的userId，itemId，value，time<br>3.完成导入后，设置系统定时器，启动MapReduce程序，运行推荐算法。<br>4.完成计算后，设置系统定时器，从HDFS导出推荐结果数据到数据库，方便以后的及时查询。</p>
<p><strong>四 程序开发：MapReduce程序的实现</strong><br>开发环境：Ubuntu 16.04, IntelliJ IDEA， 和Hadoop2.8.0<br>新建类：<br>    Recommend.java，主任务启动程序<br>    Step1.java，按用户分组，计算所有物品出现的组合列表，得到用户对物品的评分矩阵<br>    Step2.java，对物品组合列表进行计数，建立物品的同现矩阵<br>    Step3.java，对同现矩阵和评分矩阵转型<br>    *Step4.java，计算推荐结果列表，结果会出问题，最终不用这个类<br>    Step4_Update.java, 计算部分评分<br>    Step4_Update2.java, 计算最终评分，得到推荐结果<br>    HdfsDAO.java，HDFS操作工具类</p>
<p><em>1）.Recommend.java,任务驱动程序</em><br>​<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recommend</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern DELIMITER = Pattern.compile(<span class="string">"[\t,]"</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HDFS = <span class="string">"hdfs://localhost/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; path = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        path.put(<span class="string">"data"</span>, <span class="string">"resources/small.csv"</span>);</span><br><span class="line">        path.put(<span class="string">"Step1Input"</span>, HDFS + <span class="string">"/user/hdfs/recommend"</span>);</span><br><span class="line">        path.put(<span class="string">"Step1Output"</span>, path.get(<span class="string">"Step1Input"</span>) + <span class="string">"/step1"</span>);</span><br><span class="line">        path.put(<span class="string">"Step2Input"</span>, path.get(<span class="string">"Step1Output"</span>));</span><br><span class="line">        path.put(<span class="string">"Step2Output"</span>, path.get(<span class="string">"Step1Input"</span>) + <span class="string">"/step2"</span>);</span><br><span class="line">        path.put(<span class="string">"Step3Input1"</span>, path.get(<span class="string">"Step1Output"</span>));</span><br><span class="line">        path.put(<span class="string">"Step3Output1"</span>, path.get(<span class="string">"Step1Input"</span>) + <span class="string">"/step3_1"</span>);</span><br><span class="line">        path.put(<span class="string">"Step3Input2"</span>, path.get(<span class="string">"Step2Output"</span>));</span><br><span class="line">        path.put(<span class="string">"Step3Output2"</span>, path.get(<span class="string">"Step1Input"</span>) + <span class="string">"/step3_2"</span>);</span><br><span class="line"></span><br><span class="line">        path.put(<span class="string">"Step4Input1"</span>, path.get(<span class="string">"Step3Output1"</span>));</span><br><span class="line">        path.put(<span class="string">"Step4Input2"</span>, path.get(<span class="string">"Step3Output2"</span>));</span><br><span class="line">        path.put(<span class="string">"Step4Output"</span>, path.get(<span class="string">"Step1Input"</span>) + <span class="string">"/step4"</span>);</span><br><span class="line"></span><br><span class="line">        path.put(<span class="string">"Step5Input1"</span>, path.get(<span class="string">"Step3Output1"</span>));</span><br><span class="line">        path.put(<span class="string">"Step5Input2"</span>, path.get(<span class="string">"Step3Output2"</span>));</span><br><span class="line">        path.put(<span class="string">"Step5Output"</span>, path.get(<span class="string">"Step1Input"</span>) + <span class="string">"/step5"</span>);</span><br><span class="line"></span><br><span class="line">        path.put(<span class="string">"Step6Input"</span>, path.get(<span class="string">"Step5Output"</span>));</span><br><span class="line">        path.put(<span class="string">"Step6Output"</span>, path.get(<span class="string">"Step1Input"</span>) + <span class="string">"/step6"</span>);</span><br><span class="line"></span><br><span class="line">        Step1.run(path);</span><br><span class="line">        Step2.run(path);</span><br><span class="line">        Step3.run(path);</span><br><span class="line">        Step3.run2(path);</span><br><span class="line">        Step4.run(path);<span class="comment">//NullPointerException,可能不会先构造同现矩阵</span></span><br><span class="line"><span class="comment">//        Step4_Update.run(path);</span></span><br><span class="line">        Step4_Update2.run(path);</span><br><span class="line"></span><br><span class="line">        System.exit(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>2). Step1.java，按用户分组，计算所有物品出现的组合列表，得到用户对物品的评分矩阵</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hdfs.HdfsDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Step1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Step1_ToItemPreMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            String tokens[] = Recommend.DELIMITER.split(value.toString());</span><br><span class="line">            <span class="keyword">int</span> userId = Integer.parseInt(tokens[<span class="number">0</span>]);</span><br><span class="line">            String itemId = tokens[<span class="number">1</span>];</span><br><span class="line">            String pref = tokens[<span class="number">2</span>];</span><br><span class="line">            context.write(<span class="keyword">new</span> IntWritable(userId), <span class="keyword">new</span> Text(itemId + <span class="string">":"</span> + pref));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Step1_ToUserVectorReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">IntWritable</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(IntWritable key, Iterable&lt;Text&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            Iterator&lt;Text&gt; iter = values.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                sb.append(<span class="string">","</span> + iter.next());</span><br><span class="line">            &#125;</span><br><span class="line">            context.write(key, <span class="keyword">new</span> Text(sb.toString().replaceFirst(<span class="string">","</span>, <span class="string">""</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Map&lt;String, String&gt; path)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line">        String input = path.get(<span class="string">"Step1Input"</span>);</span><br><span class="line">        String output = path.get(<span class="string">"Step1Output"</span>);</span><br><span class="line"></span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line"><span class="comment">//        conf.set("mapreduce.task.io.sort.mb","1024");//任务内部排序缓冲区大小,默认为100</span></span><br><span class="line"></span><br><span class="line">        Job job = <span class="keyword">new</span> Job(conf, <span class="string">"Step1"</span>);</span><br><span class="line">        HdfsDAO hdfs = <span class="keyword">new</span> HdfsDAO(Recommend.HDFS, conf);</span><br><span class="line">        hdfs.rmr(input);</span><br><span class="line">        hdfs.mkdirs(input);</span><br><span class="line">        hdfs.copyFile(path.get(<span class="string">"data"</span>), input);</span><br><span class="line"></span><br><span class="line">        job.setJarByClass(Step1.class);</span><br><span class="line">        job.setMapOutputKeyClass(IntWritable.class);</span><br><span class="line">        job.setMapOutputValueClass(Text.class);</span><br><span class="line"></span><br><span class="line">        job.setOutputKeyClass(IntWritable.class);</span><br><span class="line">        job.setOutputValueClass(Text.class);</span><br><span class="line"></span><br><span class="line">        job.setInputFormatClass(TextInputFormat.class);</span><br><span class="line">        job.setOutputFormatClass(TextOutputFormat.class);</span><br><span class="line"></span><br><span class="line">        job.setMapperClass(Step1_ToItemPreMapper.class);</span><br><span class="line">        job.setReducerClass(Step1_ToUserVectorReducer.class);</span><br><span class="line">        job.setCombinerClass(Step1_ToUserVectorReducer.class);</span><br><span class="line"></span><br><span class="line">        FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(input));</span><br><span class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(output));</span><br><span class="line"></span><br><span class="line">        job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>map阶段：用正则表达式分割输入数据，以userId为键，图书id和打分组合成字符串itemId：pref传递给Reducer<br>reduce阶段：此时传进来的key已经按照userId分好块，于是我们可以得到每个用户的评分矩阵<br>Step1的输出为：<br><img src="http://p5s7d12ls.bkt.clouddn.com/18-3-28/97798258.jpg" alt=""></p>
<p><em>3). Step2.java，对物品组合列表进行计数，建立物品的同现矩阵</em><br>​<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hdfs.HdfsDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Step2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Step2_UserVectorToCooccurrenceMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Text k = <span class="keyword">new</span> Text();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> IntWritable v = <span class="keyword">new</span> IntWritable(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            String[] tokens = Recommend.DELIMITER.split(value.toString());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; tokens.length; i++) &#123;</span><br><span class="line">                String itemId = tokens[i].split(<span class="string">":"</span>)[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; tokens.length; j++) &#123;</span><br><span class="line">                    String itemId2 = tokens[j].split(<span class="string">":"</span>)[<span class="number">0</span>];</span><br><span class="line">                    context.write(<span class="keyword">new</span> Text(itemId + <span class="string">":"</span> + itemId2), v);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Step2_UserVectorToCooccurrenceReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">            Iterator&lt;IntWritable&gt; iter = values.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                sum += iter.next().get();</span><br><span class="line">            &#125;</span><br><span class="line">            context.write(key, <span class="keyword">new</span> IntWritable(sum));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Map&lt;String, String&gt; path)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">        Job job = <span class="keyword">new</span> Job(conf, <span class="string">"Step2"</span>);</span><br><span class="line"></span><br><span class="line">        String input = path.get(<span class="string">"Step2Input"</span>);</span><br><span class="line">        String output = path.get(<span class="string">"Step2Output"</span>);</span><br><span class="line">        System.out.println(output);</span><br><span class="line">        HdfsDAO hdfs = <span class="keyword">new</span> HdfsDAO(Recommend.HDFS, conf);</span><br><span class="line">        hdfs.rmr(output);</span><br><span class="line"></span><br><span class="line">        job.setJarByClass(Step2.class);</span><br><span class="line"></span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(IntWritable.class);</span><br><span class="line"></span><br><span class="line">        job.setMapperClass(Step2_UserVectorToCooccurrenceMapper.class);</span><br><span class="line">        job.setCombinerClass(Step2_UserVectorToCooccurrenceReducer.class);</span><br><span class="line">        job.setReducerClass(Step2_UserVectorToCooccurrenceReducer.class);</span><br><span class="line"></span><br><span class="line">        job.setInputFormatClass(TextInputFormat.class);</span><br><span class="line">        job.setOutputFormatClass(TextOutputFormat.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(input));</span><br><span class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(output));</span><br><span class="line"></span><br><span class="line">        job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Step2的输入是Step1的输出，<br>map阶段：用正则表达式分割每行，利用双重循环构造每行中任意两个itemsId的组合作为键，用数字1作为值输出到Reducer<br>reduce阶段：Mapper传来的数据已经按键分块，累加每种键下的值即可得到item1和item2出现在同一个评分列表中的次数，即得到图书的同现矩阵<br>Step2的输出为：<br><img src="http://p5s7d12ls.bkt.clouddn.com/18-3-28/19253791.jpg" alt=""></p>
<p><em>4). Step3.java，合并同现矩阵和评分矩阵</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hdfs.HdfsDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Step3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Step31_UserVectorSplitterMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> IntWritable k = <span class="keyword">new</span> IntWritable();</span><br><span class="line">        <span class="keyword">private</span> Text v = <span class="keyword">new</span> Text();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            String[] tokens = Recommend.DELIMITER.split(value.toString());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; tokens.length; i++) &#123;</span><br><span class="line">                String[] vector = tokens[i].split(<span class="string">":"</span>);</span><br><span class="line">                <span class="keyword">int</span> itemId = Integer.parseInt(vector[<span class="number">0</span>]);</span><br><span class="line">                String pref = vector[<span class="number">1</span>];</span><br><span class="line">                k.set(itemId);</span><br><span class="line">                v.set(tokens[<span class="number">0</span>] + <span class="string">":"</span> + pref);</span><br><span class="line">                context.write(k, v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Map&lt;String, String&gt; path)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">        Job job = <span class="keyword">new</span> Job(conf, <span class="string">"step31_spliteUserVector"</span>);</span><br><span class="line">        String input = path.get(<span class="string">"Step3Input1"</span>);</span><br><span class="line">        String output = path.get(<span class="string">"Step3Output1"</span>);</span><br><span class="line"></span><br><span class="line">        HdfsDAO hdfs = <span class="keyword">new</span> HdfsDAO(conf);</span><br><span class="line">        hdfs.rmr(output);</span><br><span class="line">        job.setJarByClass(Step3.class);</span><br><span class="line">        job.setMapOutputKeyClass(IntWritable.class);</span><br><span class="line">        job.setMapOutputValueClass(Text.class);</span><br><span class="line"></span><br><span class="line">        job.setMapperClass(Step31_UserVectorSplitterMapper.class);</span><br><span class="line"></span><br><span class="line">        job.setInputFormatClass(TextInputFormat.class);</span><br><span class="line">        job.setOutputFormatClass(TextOutputFormat.class);</span><br><span class="line"></span><br><span class="line">        FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(input));</span><br><span class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(output));</span><br><span class="line"></span><br><span class="line">        job.setNumReduceTasks(<span class="number">0</span>);</span><br><span class="line">        job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Step32_CooccurreceColumWrapperMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Text k = <span class="keyword">new</span> Text();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> IntWritable v = <span class="keyword">new</span> IntWritable();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            String tokens[] = Recommend.DELIMITER.split(value.toString());</span><br><span class="line">            k.set(tokens[<span class="number">0</span>]);</span><br><span class="line">            v.set(Integer.parseInt(tokens[<span class="number">1</span>])); <span class="comment">//这里和step2的输出有什么区别????</span></span><br><span class="line">            context.write(k, v);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run2</span><span class="params">(Map&lt;String, String&gt; path)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">        Job job = <span class="keyword">new</span> Job(conf, <span class="string">"step32_cooccurreceMap"</span>);</span><br><span class="line">        String input = path.get(<span class="string">"Step3Input2"</span>);</span><br><span class="line">        String output = path.get(<span class="string">"Step3Output2"</span>);</span><br><span class="line">        job.setJarByClass(Step3.class);</span><br><span class="line">        HdfsDAO hdfs = <span class="keyword">new</span> HdfsDAO(conf);</span><br><span class="line">        hdfs.rmr(output);</span><br><span class="line"></span><br><span class="line">        job.setMapOutputKeyClass(Text.class);</span><br><span class="line">        job.setMapOutputValueClass(IntWritable.class);</span><br><span class="line"></span><br><span class="line">        job.setMapperClass(Step32_CooccurreceColumWrapperMapper.class);</span><br><span class="line"></span><br><span class="line">        job.setInputFormatClass(TextInputFormat.class);</span><br><span class="line">        job.setOutputFormatClass(TextOutputFormat.class);</span><br><span class="line"></span><br><span class="line">        FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(input));</span><br><span class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(output));</span><br><span class="line"></span><br><span class="line">        job.setNumReduceTasks(<span class="number">0</span>);</span><br><span class="line">        job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Step3_1将用户评分矩阵拆分为itemId    userId:pref的形式输出，为了方便之后的计算<br>Step3_2看起来输出结果与Step2相同<br>Step3_1输出：<br><img src="http://p5s7d12ls.bkt.clouddn.com/18-3-28/9400783.jpg" alt=""><br>Step3_1输出：<br><img src="http://p5s7d12ls.bkt.clouddn.com/18-3-28/22519877.jpg" alt=""></p>
<p><em>5). Step4.java，计算推荐结果列表</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hdfs.HdfsDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Step4</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Step4_PartialMultiplyMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> IntWritable k = <span class="keyword">new</span> IntWritable();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Text v = <span class="keyword">new</span> Text();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;Integer, List&lt;Cooccurrence&gt;&gt; cooccurrenceMatrix = <span class="keyword">new</span> HashMap&lt;Integer, List&lt;Cooccurrence&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            String[] tokens = Recommend.DELIMITER.split(value.toString());</span><br><span class="line"></span><br><span class="line">            String[] v1 = tokens[<span class="number">0</span>].split(<span class="string">":"</span>);</span><br><span class="line">            String[] v2 = tokens[<span class="number">1</span>].split(<span class="string">":"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (v1.length &gt; <span class="number">1</span>) &#123;<span class="comment">// cooccurrence</span></span><br><span class="line">                <span class="keyword">int</span> itemID1 = Integer.parseInt(v1[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">int</span> itemID2 = Integer.parseInt(v1[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">int</span> num = Integer.parseInt(tokens[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">                List&lt;Cooccurrence&gt; list = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (!cooccurrenceMatrix.containsKey(itemID1)) &#123;</span><br><span class="line">                    list = <span class="keyword">new</span> ArrayList&lt;Cooccurrence&gt;();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    list = cooccurrenceMatrix.get(itemID1);</span><br><span class="line">                &#125;</span><br><span class="line">                list.add(<span class="keyword">new</span> Cooccurrence(itemID1, itemID2, num));</span><br><span class="line">                cooccurrenceMatrix.put(itemID1, list);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (v2.length &gt; <span class="number">1</span>) &#123;<span class="comment">// userVector</span></span><br><span class="line">                <span class="keyword">int</span> itemID = Integer.parseInt(tokens[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">int</span> userID = Integer.parseInt(v2[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">double</span> pref = Double.parseDouble(v2[<span class="number">1</span>]);</span><br><span class="line">                k.set(userID);</span><br><span class="line">                <span class="keyword">for</span> (Cooccurrence co : cooccurrenceMatrix.get(itemID)) &#123;</span><br><span class="line">                    v.set(co.getItemID2() + <span class="string">","</span> + pref * co.getNum());</span><br><span class="line">                    context.write(k, v);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Step4_AggregateAndRecommendReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">IntWritable</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Text v = <span class="keyword">new</span> Text();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(IntWritable key, Iterable&lt;Text&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            Map&lt;String, Double&gt; result = <span class="keyword">new</span> HashMap&lt;String, Double&gt;();</span><br><span class="line">            Iterator&lt;Text&gt; iter = values.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                String[] str = iter.next().toString().split(<span class="string">","</span>);</span><br><span class="line">                <span class="keyword">if</span> (result.containsKey(str[<span class="number">0</span>])) &#123;</span><br><span class="line">                    result.put(str[<span class="number">0</span>], result.get(str[<span class="number">0</span>]) + Double.parseDouble(str[<span class="number">1</span>]));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    result.put(str[<span class="number">0</span>], Double.parseDouble(str[<span class="number">1</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Iterator&lt;String&gt; iter2 = result.keySet().iterator();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                String itemID = iter2.next();</span><br><span class="line">                <span class="keyword">double</span> score = result.get(itemID);</span><br><span class="line">                v.set(itemID + <span class="string">","</span> + score);</span><br><span class="line">                context.write(key, v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Map&lt;String, String&gt; path)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line">        String input1 = path.get(<span class="string">"Step4Input1"</span>);</span><br><span class="line">        String input2 = path.get(<span class="string">"Step4Input2"</span>);</span><br><span class="line">        String output = path.get(<span class="string">"Step4Output"</span>);</span><br><span class="line"></span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">        Job job = <span class="keyword">new</span> Job(conf, <span class="string">"Step4"</span>);</span><br><span class="line">        HdfsDAO hdfs = <span class="keyword">new</span> HdfsDAO(Recommend.HDFS, conf);</span><br><span class="line">        hdfs.rmr(output);</span><br><span class="line">        job.setJarByClass(Step4.class);</span><br><span class="line"></span><br><span class="line">        job.setOutputKeyClass(IntWritable.class);</span><br><span class="line">        job.setOutputValueClass(Text.class);</span><br><span class="line"></span><br><span class="line">        job.setInputFormatClass(TextInputFormat.class);</span><br><span class="line">        job.setOutputFormatClass(TextOutputFormat.class);</span><br><span class="line"></span><br><span class="line">        job.setMapperClass(Step4_PartialMultiplyMapper.class);</span><br><span class="line">        job.setReducerClass(Step4_AggregateAndRecommendReducer.class);</span><br><span class="line">        job.setCombinerClass(Step4_AggregateAndRecommendReducer.class);</span><br><span class="line"></span><br><span class="line">        FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(input1), <span class="keyword">new</span> Path(input2));</span><br><span class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(output));</span><br><span class="line"></span><br><span class="line">        job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cooccurrence</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> itemID1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> itemID2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> num;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Cooccurrence</span><span class="params">(<span class="keyword">int</span> itemID1, <span class="keyword">int</span> itemID2, <span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.itemID1 = itemID1;</span><br><span class="line">        <span class="keyword">this</span>.itemID2 = itemID2;</span><br><span class="line">        <span class="keyword">this</span>.num = num;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemID1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> itemID1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemID2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> itemID2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> num;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setItemID1</span><span class="params">(<span class="keyword">int</span> itemID1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.itemID1 = itemID1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setItemID2</span><span class="params">(<span class="keyword">int</span> itemID2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.itemID2 = itemID2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNum</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.num = num;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Step4的输入来自两个路径，分别是step3_1和step3_2的输出，<br>map阶段：对输入的值进行分割，如果是同现矩阵其将被分割为<code>[101:102,3]</code>的形式，如果是评分矩阵将被分割为<code>[102,5:30]</code>的形式，然后以“：”为分隔符分别分割数组tokens中的元素，以此来判别输入是什么类型的矩阵。如果是同现矩阵，获取itemID1和itemID2以及num，在初始化时创建的静态map中填充以每一个itemID1为键，以List<cooccurence>对象为值的数据，最后得到的map形象的表示为下图所示的方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;101：[cooccurence(101,101,5),cooccurence(101,102,3),...],</span><br><span class="line">...</span><br><span class="line">106:[cooccurence(106,101,2),cooccurence(106,101,1),...],</span><br><span class="line">107:[cooccurence(107,101,1)&#125;</span><br></pre></td></tr></table></figure></cooccurence></p>
<p>如果输入来自用户评分矩阵，会先得到itemID，userID和评分pref，然后将userID设为键，利用itemID从上面的map中得到其对应的list，从list中可以得到<em>同现item</em>（通过<code>co.getItemID2()</code>）和<em>同现次数num</em>，对list中的每项都能得到一个输出，将输出值设为组合字符串“同现item，pref*同现num”，我将通过下图来解释第二项的意义，请读者自行体会。</p>
<p><img src="http://p5s7d12ls.bkt.clouddn.com/18-3-28/60596269.jpg" alt=""></p>
<p>reduce阶段逻辑比较简单，将每个item对应的值加起来就是用户对这个item的推荐的程度。<br>Step4在执行的时候会报错：<br><img src="http://p5s7d12ls.bkt.clouddn.com/18-3-28/51842026.jpg" alt=""></p>
<p>原因在于当输入是用户评分矩阵时，同现map并不是随时就绪的，可能不会先构造同现矩阵。因为hadoop从hdfs上读取小文件时，会先读占用空间大的文件，这样就不能保证先生成coocurenceMatrix了，所以Step4.java这个类不能使用，我们把矩阵乘法进行分开计算，先进行对于位置相乘Step4_Updata.java，最后进行加法Step4_Updata2.java</p>
<p><strong>5). Step4_Update.java，计算推荐结果列表</strong></p>
<p>​<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hdfs.HdfsDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileSplit;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Step4_Update</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Step4_PartialMultiplyMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String flag;<span class="comment">//A同现矩阵,B用户评分矩阵</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            FileSplit split = (FileSplit) context.getInputSplit();</span><br><span class="line">            flag = split.getPath().getParent().getName();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            String[] tokens = Recommend.DELIMITER.split(value.toString());</span><br><span class="line">            <span class="keyword">if</span> (flag.equals(<span class="string">"step3_2"</span>)) &#123;</span><br><span class="line">                String[] v1 = tokens[<span class="number">0</span>].split(<span class="string">":"</span>);</span><br><span class="line">                String itemID1 = v1[<span class="number">0</span>];</span><br><span class="line">                String itemID2 = v1[<span class="number">1</span>];</span><br><span class="line">                String num = tokens[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                Text k = <span class="keyword">new</span> Text(itemID1);</span><br><span class="line">                Text v = <span class="keyword">new</span> Text(<span class="string">"A:"</span> + itemID2 + <span class="string">","</span> + num);</span><br><span class="line">                context.write(k, v);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (flag.equals(<span class="string">"step3_1"</span>)) &#123;</span><br><span class="line">                String[] v2 = tokens[<span class="number">1</span>].split(<span class="string">":"</span>);</span><br><span class="line">                String itemID = tokens[<span class="number">0</span>];</span><br><span class="line">                String userID = v2[<span class="number">0</span>];</span><br><span class="line">                String pref = v2[<span class="number">1</span>];</span><br><span class="line">                Text k = <span class="keyword">new</span> Text(itemID);</span><br><span class="line">                Text v = <span class="keyword">new</span> Text(<span class="string">"B:"</span> + userID + <span class="string">","</span> + pref);</span><br><span class="line">                context.write(k, v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Step4_AggregateReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;Text&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            <span class="comment">//System.out.println(key.toString() + ":");</span></span><br><span class="line">            Map&lt;String, String&gt; mapA = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">            Map&lt;String, String&gt; mapB = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Text line : values) &#123;</span><br><span class="line">                String val = line.toString();</span><br><span class="line">                <span class="comment">//System.out.println(val);</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (val.startsWith(<span class="string">"A:"</span>)) &#123;</span><br><span class="line">                    String[] kv = Recommend.DELIMITER.split(val.substring(<span class="number">2</span>));</span><br><span class="line">                    mapA.put(kv[<span class="number">0</span>], kv[<span class="number">1</span>]);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val.startsWith(<span class="string">"B:"</span>)) &#123;</span><br><span class="line">                    String[] kv = Recommend.DELIMITER.split(val.substring(<span class="number">2</span>));</span><br><span class="line">                    mapB.put(kv[<span class="number">0</span>], kv[<span class="number">1</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">double</span> result = <span class="number">0</span>;</span><br><span class="line">            Iterator&lt;String&gt; iter = mapA.keySet().iterator();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                String mapk = iter.next();<span class="comment">//itemID2</span></span><br><span class="line">                <span class="keyword">int</span> num = Integer.parseInt(mapA.get(mapk));</span><br><span class="line">                Iterator&lt;String&gt; iterb = mapB.keySet().iterator();<span class="comment">//userID</span></span><br><span class="line">                <span class="keyword">while</span> (iterb.hasNext()) &#123;</span><br><span class="line">                    String mapkb = iterb.next();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">double</span> pref = Double.parseDouble(mapB.get(mapkb));</span><br><span class="line">                    result = num * pref;</span><br><span class="line">                    Text k = <span class="keyword">new</span> Text(mapkb);</span><br><span class="line">                    Text v = <span class="keyword">new</span> Text(mapk + <span class="string">","</span> + result);</span><br><span class="line">                    context.write(k, v);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Map&lt;String, String&gt; path)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">        Job job = <span class="keyword">new</span> Job(conf);</span><br><span class="line">        String input1 = path.get(<span class="string">"Step5Input1"</span>);</span><br><span class="line">        String input2 = path.get(<span class="string">"Step5Input2"</span>);</span><br><span class="line">        String output = path.get(<span class="string">"Step5Output"</span>);</span><br><span class="line"></span><br><span class="line">        HdfsDAO hdfs = <span class="keyword">new</span> HdfsDAO(Recommend.HDFS, conf);</span><br><span class="line">        hdfs.rmr(output);</span><br><span class="line"></span><br><span class="line">        job.setJarByClass(Step4_Update.class);</span><br><span class="line"></span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(Text.class);</span><br><span class="line"></span><br><span class="line">        job.setMapperClass(Step4_Update.Step4_PartialMultiplyMapper.class);</span><br><span class="line">        job.setReducerClass(Step4_Update.Step4_AggregateReducer.class);</span><br><span class="line"></span><br><span class="line">        job.setInputFormatClass(TextInputFormat.class);</span><br><span class="line">        job.setOutputFormatClass(TextOutputFormat.class);</span><br><span class="line"></span><br><span class="line">        FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(input1), <span class="keyword">new</span> Path(input2));</span><br><span class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(output));</span><br><span class="line"></span><br><span class="line">        job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在Mapper的setup阶段，通过<code>split.getPath().getParent().getName()</code>来确定输入来自那个文件，如果来自用户评分矩阵，则输出以A：打头的值，否则以B：打头，键均为itemID<br>redece阶段：键为item1，创建mapA和mapB，mapA的内容为（item2,num），mapB的值为(userId，pref),对于mapA中的每个item2和num，为每个user计算num<em>pref，输出的值为（userId，“itemID2,num</em>pref”）<br><img src="http://p5s7d12ls.bkt.clouddn.com/18-3-28/27264349.jpg" alt=""></p>
<p>step4_update.java输出是：<br><img src="http://p5s7d12ls.bkt.clouddn.com/18-3-28/96688878.jpg" alt=""> </p>
<p><strong>6).Step4_Update2.java:计算推荐结果</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hdfs.HdfsDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Step4_Update2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Step4_RecommendMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            String[] tokens = Recommend.DELIMITER.split(value.toString());</span><br><span class="line">            Text k = <span class="keyword">new</span> Text(tokens[<span class="number">0</span>]);</span><br><span class="line">            Text v = <span class="keyword">new</span> Text(tokens[<span class="number">1</span>] + <span class="string">","</span> + tokens[<span class="number">2</span>]);</span><br><span class="line">            context.write(k,v);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Step4_RecommendReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>,<span class="title">Text</span>, <span class="title">Text</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;Text&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            System.out.println(key.toString());</span><br><span class="line">            Map&lt;String, Double&gt; map = <span class="keyword">new</span> HashMap&lt;String, Double&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Text line : values) &#123;</span><br><span class="line">                System.out.println(line.toString());</span><br><span class="line">                String [] tokens = Recommend.DELIMITER.split(line.toString());</span><br><span class="line">                String itemID = tokens[<span class="number">0</span>];</span><br><span class="line">                Double score = Double.parseDouble(tokens[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (map.containsKey(itemID)) &#123;</span><br><span class="line">                    map.put(itemID, map.get(itemID) + score);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    map.put(itemID, score);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Iterator&lt;String&gt; iter = map.keySet().iterator();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                String itemID = iter.next();</span><br><span class="line">                <span class="keyword">double</span> score = map.get(itemID);</span><br><span class="line">                Text v = <span class="keyword">new</span> Text(itemID + <span class="string">","</span> + score);</span><br><span class="line">                context.write(key,v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Map&lt;String, String&gt; path)</span> <span class="keyword">throws</span> InterruptedException, IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line"></span><br><span class="line">        String input = path.get(<span class="string">"Step6Input"</span>);</span><br><span class="line">        String output = path.get(<span class="string">"Step6Output"</span>);</span><br><span class="line"></span><br><span class="line">        HdfsDAO hdfs = <span class="keyword">new</span> HdfsDAO(Recommend.HDFS, conf);</span><br><span class="line">        hdfs.rmr(output);</span><br><span class="line">        Job job = <span class="keyword">new</span> Job(conf);</span><br><span class="line">        job.setJarByClass(Step4_Update2.class);</span><br><span class="line"></span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(Text.class);</span><br><span class="line"></span><br><span class="line">        job.setMapperClass(Step4_Update2.Step4_RecommendMapper.class);</span><br><span class="line">        job.setReducerClass(Step4_Update2.Step4_RecommendReducer.class);</span><br><span class="line"></span><br><span class="line">        job.setInputFormatClass(TextInputFormat.class);</span><br><span class="line">        job.setOutputFormatClass(TextOutputFormat.class);</span><br><span class="line"></span><br><span class="line">        FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(input));</span><br><span class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(output));</span><br><span class="line"></span><br><span class="line">        job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>较为简单，求和即可，结果如下：<br><img src="http://p5s7d12ls.bkt.clouddn.com/18-3-28/61332065.jpg" alt=""><br>五、程序开发：爬虫的编写<br>本爬虫爬取图书的信息，未整理完毕，可以根据需求更改<br>item.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoubanbooksItem</span><span class="params">(scrapy.Item)</span>:</span></span><br><span class="line">    book_name = scrapy.Field()  <span class="comment"># 图书名</span></span><br><span class="line">    book_star = scrapy.Field()  <span class="comment"># 图书评分</span></span><br><span class="line">    book_pl = scrapy.Field()  <span class="comment"># 图书评论数</span></span><br><span class="line">    book_author = scrapy.Field()  <span class="comment"># 图书作者</span></span><br><span class="line">    book_publish = scrapy.Field()  <span class="comment"># 出版社</span></span><br><span class="line">    book_date = scrapy.Field()  <span class="comment"># 出版日期</span></span><br><span class="line">    book_price = scrapy.Field()  <span class="comment"># 图书价格</span></span><br><span class="line">    book_tag = scrapy.Field()</span><br><span class="line">    book_desc = scrapy.Field()</span><br><span class="line">    book_id = scrapy.Field()</span><br></pre></td></tr></table></figure></p>
<p>bookspider.py<br>​<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor</span><br><span class="line"><span class="keyword">from</span> scrapy.spiders <span class="keyword">import</span> CrawlSpider, Rule</span><br><span class="line"><span class="keyword">from</span> scrapy.selector <span class="keyword">import</span> Selector</span><br><span class="line"><span class="keyword">from</span> doubanBooks.items <span class="keyword">import</span> DoubanbooksItem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookspiderSpider</span><span class="params">(CrawlSpider)</span>:</span></span><br><span class="line">    name = <span class="string">'bookspider'</span></span><br><span class="line">    allowed_domains = [<span class="string">'douban.com'</span>]</span><br><span class="line">    start_urls = [<span class="string">"https://book.douban.com/tag/"</span>]</span><br><span class="line">    rules = (</span><br><span class="line">        Rule(LinkExtractor(allow=<span class="string">r'tag/.&#123;2,4&#125;'</span>), callback=<span class="string">'parse_item'</span>, follow=<span class="keyword">False</span>),</span><br><span class="line">        Rule(LinkExtractor(allow=<span class="string">r'https://book.douban.com/tag/.+/?start=\d+&amp;type=T'</span>), callback=<span class="string">'parse_item2'</span>, follow=<span class="keyword">True</span>),</span><br><span class="line">        <span class="comment"># Rule(LinkExtractor(allow=r'https://book.douban.com/subject/\d+/'), callback='parse_item2',follow=False),</span></span><br><span class="line">        <span class="comment"># Rule(LinkExtractor(allow=r'https://book.douban.com/subject/\d/reviews'), callback='parse_item3', follow=False),</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># def start_requests(self):</span></span><br><span class="line">    <span class="comment">#     '''</span></span><br><span class="line">    <span class="comment">#     重写start_requests，请求登录页面</span></span><br><span class="line">    <span class="comment">#     '''</span></span><br><span class="line">    <span class="comment">#     return [scrapy.FormRequest("https://accounts.douban.com/login", meta=&#123;"cookiejar": 1&#125;,</span></span><br><span class="line">    <span class="comment">#                                callback=self.parse_before_login)]</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item0</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        sel = Selector(response);</span><br><span class="line">        <span class="comment"># item['book_tag'] = sel.xpath('/html/body/div[3]/div[1]/h1/text()').extract()[0].split(':')[1].strip()</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">       <span class="comment"># print(response)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item2</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        sel = Selector(response)</span><br><span class="line">        item = DoubanbooksItem()</span><br><span class="line">        item[<span class="string">'book_tag'</span>] = sel.xpath(<span class="string">'/html/body/div[3]/div[1]/h1/text()'</span>).extract()[<span class="number">0</span>].strip().split(<span class="string">':'</span>)[<span class="number">1</span>]</span><br><span class="line">        book_list = sel.css(<span class="string">'#subject_list &gt; ul &gt; li'</span>)</span><br><span class="line">        <span class="keyword">for</span> book <span class="keyword">in</span> book_list:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># strip() 方法用于移除字符串头尾指定的字符（默认为空格）</span></span><br><span class="line">                item[<span class="string">'book_name'</span>] = book.xpath(<span class="string">'div[@class="info"]/h2/a/text()'</span>).extract()[<span class="number">0</span>].strip()</span><br><span class="line">                item[<span class="string">'book_star'</span>] = book.xpath(<span class="string">"div[@class='info']/div[2]/span[@class='rating_nums']/text()"</span>).extract()[<span class="number">0</span>].strip()</span><br><span class="line">                item[<span class="string">'book_pl'</span>] = book.xpath(<span class="string">"div[@class='info']/div[2]/span[@class='pl']/text()"</span>).extract()[<span class="number">0</span>].strip()</span><br><span class="line">                item[<span class="string">'book_desc'</span>] = book.xpath(<span class="string">"div[2]/p/text()"</span>).extract()[<span class="number">0</span>]</span><br><span class="line">                item[<span class="string">'book_id'</span>] = book.xpath(<span class="string">'div[@class="info"]/h2[@class=""]/a/@href'</span>).extract()[<span class="number">0</span>].strip().split(<span class="string">'/'</span>)[<span class="number">-2</span>]</span><br><span class="line">                pub = book.xpath(<span class="string">'div[@class="info"]/div[@class="pub"]/text()'</span>).extract()[<span class="number">0</span>].strip().split(<span class="string">'/'</span>)</span><br><span class="line">                item[<span class="string">'book_price'</span>] = pub.pop()</span><br><span class="line">                item[<span class="string">'book_date'</span>] = pub.pop()</span><br><span class="line">                item[<span class="string">'book_publish'</span>] = pub.pop()</span><br><span class="line">                item[<span class="string">'book_author'</span>] = <span class="string">'/'</span>.join(pub)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">yield</span> item</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def parse_item4(self, response):</span></span><br><span class="line"><span class="comment">#         sel = Selector(response);</span></span><br><span class="line"><span class="comment">#         item = DoubanbooksItem()</span></span><br><span class="line"><span class="comment">#         item['user_name'] = sel.xpath('div[@class="aside"]/div[@class="sidebar-info-wrapper"]/div[2]/a/text()').extract()[0].strip()</span></span><br><span class="line"><span class="comment">#         item['user_score'] = sel.xpath('div[@class="aside"]/div[@class="sidebar-info-wrapper"]/div[2]/a/text()').extract()[0].strip()</span></span><br><span class="line"><span class="comment">#         yield item</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_before_login</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        print(<span class="string">"登录前表单填充"</span>)</span><br><span class="line">        captcha_id = response.xpath(<span class="string">'//input[@name="captcha-id"]/@value'</span>).extract_first()</span><br><span class="line">        captcha_image_url = response.xpath(<span class="string">'//img[@id="captcha_image"]/@src'</span>).extract_first()</span><br><span class="line">        <span class="keyword">if</span> captcha_image_url <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            print(<span class="string">"登录时无验证码"</span>)</span><br><span class="line">            formdata = &#123;</span><br><span class="line">                <span class="string">"form_email"</span>: <span class="string">"18911341910"</span>,</span><br><span class="line">                <span class="comment"># 请填写你的密码</span></span><br><span class="line">                <span class="string">"form_password"</span>: <span class="string">"lh1994114"</span>,</span><br><span class="line">                <span class="string">"login"</span>: <span class="string">"登录"</span>,</span><br><span class="line">                <span class="string">"redir"</span>: <span class="string">"https://www.douban.com/"</span>,</span><br><span class="line">                <span class="string">"source"</span>: <span class="string">"index_nav"</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">"登录时有验证码"</span>)</span><br><span class="line">            save_image_path = <span class="string">"/media/harold/SpareDisk/pythonProject/captcha.jpeg"</span></span><br><span class="line">            <span class="comment"># 将图片验证码下载到本地</span></span><br><span class="line">            urllib.request.urlretrieve(captcha_image_url, save_image_path)</span><br><span class="line">            <span class="comment"># 打开图片，以便我们识别图中验证码</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                im = Image.open(save_image_path)</span><br><span class="line">                im.show()</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="comment"># 手动输入验证码</span></span><br><span class="line">            captcha_solution = input(<span class="string">'根据打开的图片输入验证码:'</span>)</span><br><span class="line">            formdata = &#123;</span><br><span class="line">                <span class="string">"source"</span>: <span class="string">"None"</span>,</span><br><span class="line">                <span class="string">"redir"</span>: <span class="string">"https://www.douban.com/"</span>,</span><br><span class="line">                <span class="string">"form_email"</span>: <span class="string">"13227708059@163.com"</span>,</span><br><span class="line">                <span class="comment"># 此处请填写密码</span></span><br><span class="line">                <span class="string">"form_password"</span>: <span class="string">"*******"</span>,</span><br><span class="line">                <span class="string">"captcha-solution"</span>: captcha_solution,</span><br><span class="line">                <span class="string">"captcha-id"</span>: captcha_id,</span><br><span class="line">                <span class="string">"login"</span>: <span class="string">"登录"</span>,</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        print(<span class="string">"登录中"</span>)</span><br><span class="line">        <span class="comment"># 提交表单</span></span><br><span class="line">        <span class="keyword">return</span> scrapy.FormRequest.from_response(response, meta=&#123;<span class="string">"cookiejar"</span>: response.meta[<span class="string">"cookiejar"</span>]&#125;,</span><br><span class="line">                                                formdata=formdata,</span><br><span class="line">                                                callback=self.parse_after_login)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_after_login</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        验证登录是否成功</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        account = response.xpath(<span class="string">'/html/body/div[1]/div/div[1]/ul/li[2]/a/span[1]'</span>).extract_first()</span><br><span class="line">        print(account)</span><br><span class="line">        <span class="keyword">if</span> account <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            print(<span class="string">"登录失败"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">u"登录成功,当前账户为 %s"</span> % account)</span><br><span class="line">            <span class="keyword">yield</span> self.make_requests_from_url(<span class="string">"https://book.douban.com/tag/"</span>)</span><br></pre></td></tr></table></figure></p>
<p>pipeline.py 输出到csv<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> signals</span><br><span class="line"><span class="keyword">from</span> scrapy.contrib.exporter <span class="keyword">import</span> CsvItemExporter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookPipeline</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span><span class="params">(cls, crawler)</span>:</span></span><br><span class="line">        pipeline = cls()</span><br><span class="line">        crawler.signals.connect(pipeline.spider_opened, signals.spider_opened)</span><br><span class="line">        crawler.signals.connect(pipeline.spider_closed, signals.spider_closed)</span><br><span class="line">        <span class="keyword">return</span> pipeline</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spider_opened</span><span class="params">(self, spider)</span>:</span></span><br><span class="line">        self.file = open(<span class="string">'output.csv'</span>, <span class="string">'w+b'</span>)</span><br><span class="line">        self.exporter = CsvItemExporter(self.file)</span><br><span class="line">        self.exporter.start_exporting()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spider_closed</span><span class="params">(self, spider)</span>:</span></span><br><span class="line">        self.exporter.finish_exporting()</span><br><span class="line">        self.file.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></span><br><span class="line">        self.exporter.export_item(item)</span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure></p>
<p>部分结果</p>
<p><img src="http://p5s7d12ls.bkt.clouddn.com/18-3-28/51973032.jpg" alt=""></p>
<p>github地址：<br>爬虫：<a href="https://github.com/Harold1994/doubanBooks" target="_blank" rel="noopener">https://github.com/Harold1994/doubanBooks</a><br>推荐系统：<a href="https://github.com/Harold1994/HadoopFileRecommendation" target="_blank" rel="noopener">https://github.com/Harold1994/HadoopFileRecommendation</a></p>
<p><code>`</code></p>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="http://7xrcp8.com1.z0.glb.clouddn.com/avatar.png" alt="avatar" />
    <div class="grid-item">
      <p class="title"> lyyourc </p>
      <p class="subtitle"> You Are The JavaScript In My HTML </p>
    <div>
  </section>

  <section class="share-btns">
    <!-- <p> share it if you like it~ </p> -->
    <a
  class="twitter-share-button"
  data-size="large"
  data-via="DrakeLeung"
  href="https://twitter.com/intent/tweet?text=《Hadoop权威指南》已经通读一遍，对"
>
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'drakeleung';
  
  var disqus_url = '//harold.me/2018/03/28/用hadoop构建豆瓣图书推荐系统/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
</main>

</body>
</html>
